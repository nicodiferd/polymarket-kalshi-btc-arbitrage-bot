version: "3.8"

services:
  # ==============================================
  # VPN Gateway - SOCKS5 Proxy for Polymarket only
  # ==============================================
  vpn:
    image: qmcgaw/gluetun
    container_name: gluetun-vpn
    cap_add:
      - NET_ADMIN
    security_opt:
      - apparmor:unconfined
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=mullvad
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${MULLVAD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${MULLVAD_ADDRESS}
      - SERVER_CITIES=Frankfurt
      - WIREGUARD_ENDPOINT_IP=185.213.155.73
      - WIREGUARD_ENDPOINT_PORT=51820
      - WIREGUARD_PUBLIC_KEY=HQHCrq4J6bSpdW1fI5hR/bvcrYa6HgGgwaa5ZY749ik=
      - FIREWALL=on
      - FIREWALL_OUTBOUND_SUBNETS=192.168.0.0/16,172.16.0.0/12,10.0.0.0/8
      - HTTP_CONTROL_SERVER_ADDRESS=:8080
      # Enable SOCKS5 proxy for selective routing
      - SHADOWSOCKS=off
      - HTTPPROXY=off
      - SOCKS5=on
      - SOCKS5_LISTENING_ADDRESS=:1080
    ports:
      # Gluetun control server
      - "8080:8080"
      # SOCKS5 proxy (internal use only, but exposed for debugging)
      - "1080:1080"
    networks:
      - arbitrage-net
    volumes:
      - ./gluetun:/gluetun
    restart: unless-stopped

  # ==============================================
  # Backend - Split routing: Polymarket via VPN, Kalshi/Binance direct
  # ==============================================
  backend:
    build: ./backend
    container_name: arbitrage-backend
    security_opt:
      - apparmor:unconfined
    ports:
      - "8000:8000"
    environment:
      # VPN Proxy for Polymarket only (geo-restricted)
      - VPN_PROXY_URL=socks5://vpn:1080
      # Polymarket credentials
      - POLYMARKET_PRIVATE_KEY=${POLYMARKET_PRIVATE_KEY}
      - POLYMARKET_FUNDER_ADDRESS=${POLYMARKET_FUNDER_ADDRESS}
      - POLYMARKET_SIGNATURE_TYPE=${POLYMARKET_SIGNATURE_TYPE:-1}
      # Kalshi credentials
      - KALSHI_API_KEY_ID=${KALSHI_API_KEY_ID}
      - KALSHI_PRIVATE_KEY_PATH=/app/keys/kalshi_private_key.pem
      - KALSHI_USE_DEMO=${KALSHI_USE_DEMO:-true}
      # Trading settings
      - PAPER_TRADING=${PAPER_TRADING:-true}
      - MIN_PROFIT_MARGIN=${MIN_PROFIT_MARGIN:-0.02}
      - MAX_POSITION_SIZE=${MAX_POSITION_SIZE:-100}
    networks:
      - arbitrage-net
    volumes:
      - ./backend:/app
      - ./keys:/app/keys:ro
    depends_on:
      - vpn
    restart: unless-stopped

  # ==============================================
  # Frontend - Next.js Dashboard
  # ==============================================
  frontend:
    build: ./frontend
    container_name: arbitrage-frontend
    security_opt:
      - apparmor:unconfined
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    networks:
      - arbitrage-net
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    restart: unless-stopped

# ==============================================
# Networks - shared network for inter-container communication
# ==============================================
networks:
  arbitrage-net:
    driver: bridge

# ==============================================
# Named volumes for persistence
# ==============================================
volumes:
  gluetun:
