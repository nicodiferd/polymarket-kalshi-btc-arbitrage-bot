version: "3.8"

services:
  # ==============================================
  # VPN Gateway - Routes Polymarket traffic through Germany
  # ==============================================
  vpn:
    image: qmcgaw/gluetun
    container_name: gluetun-vpn
    cap_add:
      - NET_ADMIN
    security_opt:
      - apparmor:unconfined
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=mullvad
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${MULLVAD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${MULLVAD_ADDRESS}
      - SERVER_CITIES=Frankfurt
      - WIREGUARD_ENDPOINT_IP=185.213.155.73
      - WIREGUARD_ENDPOINT_PORT=51820
      - WIREGUARD_PUBLIC_KEY=HQHCrq4J6bSpdW1fI5hR/bvcrYa6HgGgwaa5ZY749ik=
      - FIREWALL=on
      - FIREWALL_OUTBOUND_SUBNETS=192.168.0.0/16,172.16.0.0/12,10.0.0.0/8
      - HTTP_CONTROL_SERVER_ADDRESS=:8080
    ports:
      # Backend API exposed through VPN
      - "8000:8000"
      # Gluetun control server
      - "8080:8080"
    volumes:
      - ./gluetun:/gluetun
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 10s
      timeout: 10s
      start_period: 30s
      retries: 5
    restart: unless-stopped

  # ==============================================
  # Backend - Full API (routes through VPN for Polymarket)
  # ==============================================
  backend:
    build: ./backend
    container_name: arbitrage-backend
    network_mode: "service:vpn"
    security_opt:
      - apparmor:unconfined
    environment:
      # Polymarket credentials
      - POLYMARKET_PRIVATE_KEY=${POLYMARKET_PRIVATE_KEY}
      - POLYMARKET_FUNDER_ADDRESS=${POLYMARKET_FUNDER_ADDRESS}
      - POLYMARKET_SIGNATURE_TYPE=${POLYMARKET_SIGNATURE_TYPE:-1}
      # Kalshi credentials
      - KALSHI_API_KEY_ID=${KALSHI_API_KEY_ID}
      - KALSHI_PRIVATE_KEY_PATH=/app/keys/kalshi_private_key.pem
      - KALSHI_USE_DEMO=${KALSHI_USE_DEMO:-true}
      # Trading settings
      - PAPER_TRADING=${PAPER_TRADING:-true}
      - MIN_PROFIT_MARGIN=${MIN_PROFIT_MARGIN:-0.02}
      - MAX_POSITION_SIZE=${MAX_POSITION_SIZE:-100}
    volumes:
      - ./backend:/app
      - ./keys:/app/keys:ro
    depends_on:
      vpn:
        condition: service_healthy
    restart: unless-stopped

  # ==============================================
  # Frontend - Next.js Dashboard
  # ==============================================
  frontend:
    build: ./frontend
    container_name: arbitrage-frontend
    security_opt:
      - apparmor:unconfined
    ports:
      - "3000:3000"
    environment:
      # API endpoint (through VPN gateway)
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    depends_on:
      - backend
    restart: unless-stopped

# ==============================================
# Named volumes for persistence
# ==============================================
volumes:
  gluetun:
